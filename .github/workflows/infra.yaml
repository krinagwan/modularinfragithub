name: Terraform Pipeline
on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Select environment'
        required: true
        default: dev
        type: choice
        options:
          - dev
          - uat
          - prod

jobs:
  build:
    name: Terraform Init Plan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      # - name: Load SPN Secret to ENV
      #   run: echo "${{ secrets.SPN2 }}" >> $GITHUB_ENV

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.ARM_CLIENT_ID }}
          tenant-id: ${{ secrets.ARM_TENANT_ID }}
          subscription-id: ${{ secrets.ARM_SUBSCRIPTION_ID }}
          client-secret: ${{ secrets.ARM_CLIENT_SECRET }}


      # - name: Azure Login
      #   run: |
      #     az login --service-principal -u "$ARM_CLIENT_ID" -p "$ARM_CLIENT_SECRET" --tenant "$ARM_TENANT_ID"
      #     az account set -s "$ARM_SUBSCRIPTION_ID"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3  # installs terraform âœ”

      - name: Terraform Init
        run: terraform init -input=false -no-color

      - name: Terraform Plan
        run: terraform plan -input=false -no-color -out=tfplan.binary

      - name: Upload Terraform Plan
        uses: actions/upload-artifact@v6
        with:
          name: tfplan
          path: tfplan.binary

  deploy:
    name: Terraform Apply + Save State
    runs-on: ubuntu-latest
    needs: build
    
   # ðŸ” Manual approval yahan lagega:
    environment: approve-deploy
    
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Download Plan Artifact
        uses: actions/download-artifact@v6
        with:
          name: tfplan
          path: ./

      # - name: Load SPN Secret to ENV
      #   run: echo "${{ secrets.SPN }}" >> $GITHUB_ENV

      # - name: Azure Login
      #   run: |
      #     az login --service-principal -u "$ARM_CLIENT_ID" -p "$ARM_CLIENT_SECRET" --tenant "$ARM_TENANT_ID"
      #     az account set -s "$ARM_SUBSCRIPTION_ID"

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.ARM_CLIENT_ID }}
          tenant-id: ${{ secrets.ARM_TENANT_ID }}
          subscription-id: ${{ secrets.ARM_SUBSCRIPTION_ID }}
          client-secret: ${{ secrets.ARM_CLIENT_SECRET }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3  # installs terraform âœ”

      - name: Terraform Init
        run: terraform init -input=false -no-color

      - name: Terraform Apply using Plan
        run: terraform apply -input=false -auto-approve -no-color tfplan.binary

      - name: Upload Terraform State
        uses: actions/upload-artifact@v6
        with:
          name: tfstate
          path: terraform.tfstate